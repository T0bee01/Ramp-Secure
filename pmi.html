<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RAMPSECURE - Monthly PMI</title>

  <style>
    :root{
      --red:#C62828;
      --red-dark:#A31F1F;
      --black:#0E0E0E;
      --white:#FFFFFF;
      --gray:#f5f5f5;
      --light-gray:#fafafa;
      --green:#4CAF50;
      --orange:#FF9800;
      --blue:#2196F3;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background:var(--red);
      color:var(--black);
      overflow-x:hidden;
    }

    .container{
      width:100%;
      max-width:1000px;
      margin:0 auto;
      padding:20px;
      min-height:100vh;
      background:var(--white);
      position:relative;
    }

    .header{
  background:linear-gradient(135deg, var(--red) 0%, var(--red-dark) 100%);
  color:var(--white);
  padding:20px 30px;
  position:relative;
  margin-bottom:30px;
  border-bottom:3px solid var(--red);
    }

    .header h1{
  margin:0;
  font-size:28px;
  font-weight:900;
    }

    .home-btn{
      background:var(--white);
      color:var(--red);
      border:none;
      padding:10px 18px;
      border-radius:8px;
      font-weight:700;
      cursor:pointer;
      text-decoration:none;
      display:inline-block;
      transition:background 0.2s ease;
      position:absolute;
      top:18px;
      right:18px;
      z-index:100;
    }

    .home-btn:hover{
      background:var(--gray);
      color:var(--red-dark);
    }

    .form-section{
      background:var(--gray);
      padding:25px;
      border-radius:12px;
      margin-bottom:25px;
    }

    .form-section h2{
      color:var(--red);
      margin:0 0 20px 0;
      font-size:20px;
      font-weight:700;
    }

    .form-row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:20px;
      margin-bottom:15px;
    }

    .form-group{
      margin-bottom:15px;
    }

    .form-group label{
      display:block;
      margin-bottom:5px;
      font-weight:600;
      color:var(--black);
    }

    .form-group input,
    .form-group select,
    .form-group textarea{
      width:100%;
      padding:10px;
      border:2px solid #ddd;
      border-radius:6px;
      font-size:14px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus{
      outline:none;
      border-color:var(--red);
    }

    .equipment-selector{
      background:var(--white);
      border:2px solid var(--red);
      border-radius:8px;
      margin-bottom:20px;
    }

    .equipment-header{
      background:var(--red);
      color:var(--white);
      padding:15px 20px;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:600;
    }

    .equipment-header:hover{
      background:var(--red-dark);
    }

    .equipment-content{
      display:none;
      padding:20px;
      border-top:1px solid #ddd;
    }

    .equipment-content.active{
      display:block;
    }

    .equipment-status{
      display:inline-block;
      padding:4px 8px;
      border-radius:4px;
      font-size:12px;
      font-weight:600;
      margin-left:10px;
    }

    .status-pending{
      background:#ffecb3;
      color:#f57c00;
    }

    .status-completed{
      background:#c8e6c9;
      color:#2e7d32;
    }

    .status-skipped{
      background:#ffcdd2;
      color:#c62828;
    }

    .task-list{
      background:#fff;
      border-radius:6px;
      padding:15px;
      margin:15px 0;
    }

    .task-item{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:8px 0;
      border-bottom:1px solid #eee;
    }

    .task-item:last-child{
      border-bottom:none;
    }

    .task-checkbox{
      margin-top:2px;
    }

    .task-text{
      flex:1;
      font-size:14px;
    }

    .skip-equipment{
      background:#fff3e0;
      border:1px solid #ffcc02;
      border-radius:6px;
      padding:15px;
      margin-top:15px;
    }

    .skip-equipment label{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:600;
      color:#f57c00;
    }

    .skip-reason{
      margin-top:10px;
      display:none;
    }

    .skip-reason.show{
      display:block;
    }

    .progress-bar{
      background:#e0e0e0;
      border-radius:10px;
      height:20px;
      margin:20px 0;
      overflow:hidden;
    }

    .progress-fill{
      background:linear-gradient(90deg, var(--green) 0%, #66BB6A 100%);
      height:100%;
      width:0%;
      transition:width 0.3s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-size:12px;
      font-weight:600;
    }

    .action-buttons{
  position:sticky;
  bottom:20px;
  background:var(--white);
  padding:20px 0;
  border-top:2px solid #eee;
  margin-top:30px;
  display:flex;
  gap:15px;
  flex-wrap:wrap;
  justify-content:center;
    }

    .btn{
      padding:15px 30px;
      border:none;
      border-radius:8px;
      font-weight:700;
      font-size:16px;
      cursor:pointer;
      transition:all 0.2s ease;
      min-width:140px;
      text-transform:none;
      letter-spacing:0.5px;
    }

    .btn:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }

    .btn-primary{
      background:var(--green);
      color:var(--white);
    }

    .btn-primary:hover{
      background:#45a049;
    }

    .btn-secondary{
      background:#666;
      color:var(--white);
    }

    .btn-secondary:hover{
      background:#555;
    }

    .btn-warning{
      background:var(--orange);
      color:var(--white);
    }

    .btn-warning:hover{
      background:#f57c00;
    }

    .btn:disabled{
      opacity:0.6;
      cursor:not-allowed;
      transform:none;
    }

    .inspection-info{
      background:linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      border-radius:8px;
      padding:20px;
      margin-bottom:25px;
    }

    .info-row{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:15px;
      margin-bottom:10px;
    }

    .info-item{
      background:rgba(255,255,255,0.8);
      padding:10px;
      border-radius:6px;
    }

    .info-label{
      font-size:12px;
      color:#666;
      margin-bottom:2px;
    }

    .info-value{
      font-weight:600;
      color:var(--black);
    }

    .seasonal-equipment{
      border-left:4px solid var(--orange);
      background:linear-gradient(135deg, #fff3e0 0%, #ffecb3 100%);
    }

    .seasonal-equipment .equipment-header{
      background:var(--orange);
    }

    .seasonal-equipment .equipment-header:hover{
      background:#f57c00;
    }

    @media (max-width:768px){
      .form-row{
        grid-template-columns:1fr;
      }
      
      .action-buttons{
        flex-direction:column;
      }
      
      .btn{
        min-width:auto;
      }
      
      .header{
        flex-direction:column;
        gap:15px;
        text-align:center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìã Monthly Preventive Maintenance Inspections (PMI)</h1>
      <a href="index.html" class="home-btn"> Home</a>
    </div>

    <div class="inspection-info">
      <div class="info-row">
        <div class="info-item">
          <div class="info-label">Inspector</div>
          <div class="info-value" id="inspectorName">Loading...</div>
        </div>
        <div class="info-item">
          <div class="info-label">Station</div>
          <div class="info-value" id="stationCode">Loading...</div>
        </div>
        <div class="info-item">
          <div class="info-label">Start Time</div>
          <div class="info-value" id="startTime">--</div>
        </div>
        <div class="info-item">
          <div class="info-label">Progress</div>
          <div class="info-value" id="progressText">0% Complete</div>
        </div>
      </div>
      
      <div class="form-group" id="stationSelectGroup" style="display:none;">
        <label for="stationSelect">Select Station for Inspection:</label>
        <select id="stationSelect">
          <option value="">-- Select Station --</option>
          <option value="YQT">YQT - Thunder Bay Airport</option>
          <option value="YBR">YBR - Brandon Municipal Airport</option>
          <option value="YFC">YFC - Fredericton Airport</option>
          <option value="YTS">YTS - Timmins Victor M. Power Airport</option>
          <option value="YQG">YQG - Windsor Airport</option>
          <option value="YSJ">YSJ - Saint John Airport</option>
        </select>
      </div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="progressBar">0% Complete</div>
    </div>

    <div class="form-section">
      <h2>üîß Equipment Inspections</h2>
      <div id="equipmentList">
        <!-- Equipment items will be dynamically loaded -->
      </div>
    </div>

    <div class="form-section">
      <h2>üìù Additional Notes</h2>
      <div class="form-group">
        <label for="additionalNotes">General Comments or Observations:</label>
        <textarea id="additionalNotes" rows="4" placeholder="Enter any additional observations, recommendations, or notes about the monthly inspection..."></textarea>
      </div>
    </div>

    <div class="action-buttons">
      <button class="btn btn-primary" onclick="submitInspection()" id="submitBtn" disabled>
         Submit Monthly Inspection
      </button>
      <button class="btn btn-warning" onclick="createEDR()">
         Create EDR
      </button>
      <button class="btn btn-secondary" onclick="saveDraft()">
         Save Draft
      </button>
      <button class="btn btn-secondary" onclick="goBack()">
         Back to Main
      </button>
    </div>
  </div>

  <script>
    let currentUser = null;
    let currentStation = null;
    let isManagerAccess = false;
    let startTime = null;
    let equipmentData = {};
    let inspectionStarted = false;

    // Equipment data by station
    const stationEquipment = {
      'YBR': [
        {
          id: 'wheelchair_mover',
          name: 'WHEELCHAIR MOVER - 7458',
          category: 'General Maintenance',
          tasks: [
            'WALK AROUND - CHECK FOR BODY DAMAGE, DECALS, ASSET TAG, ETC.',
            'CHECK JAWS & HITCH FOR UNSAFE WEAR',
            'CHECK JAWS AND HITCH FOR PROPER EXTENSION',
            'CHECK JAWS AND HITCH FOR SAFE CONNECTION TO WHEELCHAIR',
            'CHECK WHEEL BEARINGS FOR ROUGHNESS DURING ROTATION',
            'CHECK CHARGER CORD FOR DAMAGE',
            'CHECK TIRES FOR WEAR OR DAMAGE',
            'CHECK BREAKING SYSTEM FOR WEAR AND PROPER OPERATION',
            'CLEAN SURFACES WITH MILD SURFACE CLEANER'
          ]
        },
        {
          id: 'stairs_7413',
          name: 'STAIRS - 7413',
          category: 'PORTABLE STAIR',
          tasks: [
            'WALK AROUND - COMPLETE VISUAL INSPECTION FOR ANY DAMAGE',
            'CHECK FOR MISSING OR LOOSE NUTS, BOLTS OR PARTS',
            'INSPECT ALL FOAM PADDING AND BUMPERS',
            'CHECK TIRE PRESSURE, WEAR OR FOR ANY DAMAGE. INFLATE AS REQUIRED',
            'CHECK CONDITION OF RUBBER END CAPS ON LEGS',
            'CHECK BRAKE OPERATION & CONDITION',
            'CHECK BRAKE ARM RELEASES FREELY FOR PARKING',
            'CHECK BRAKE ARM LATCHES SECURELY FOR TRAVEL POSITION',
            'CHECK OPERATION OF STABILIZERS, OUTRIGGERS, BRIDGE AND RAMPS',
            'CHECK NON-SLIP CONDITION, RIVETS AND SECURITY',
            'CHECK CONDITION OF GUEST HAND RAILS AND TOUCH POINTS',
            'CHECK CONDITION OF HYDRAULIC SYSTEMS AND EXTENSION LOCKS',
            'CHECK STAIR SECURITY AND OPERATION',
            'CHECK CONDITION OF RIBBON CASSETTE EXTENSION',
            'CHECK STAIR ROLLS FREELY',
            'CHECK OPERATION OF FLIP STEP AND LATCH KNOBS',
            'SPRAY WD40 ON ALL HINGE POINTS',
            'GREASE ALL FITTINGS'
          ]
        },
        {
          id: 'ramp_passenger',
          name: 'RAMP, PASSENGER - 7477',
          category: 'PORTABLE STAIR',
          tasks: [
            'WALK AROUND - COMPLETE VISUAL INSPECTION FOR ANY DAMAGE',
            'CHECK FOR MISSING OR LOOSE NUTS, BOLTS OR PARTS',
            'INSPECT ALL FOAM PADDING AND BUMPERS',
            'CHECK TIRE PRESSURE, WEAR OR FOR ANY DAMAGE. INFLATE AS REQUIRED',
            'CHECK CONDITION OF RUBBER END CAPS ON LEGS',
            'CHECK BRAKE OPERATION & CONDITION',
            'CHECK BRAKE ARM RELEASES FREELY FOR PARKING',
            'CHECK BRAKE ARM LATCHES SECURELY FOR TRAVEL POSITION',
            'CHECK OPERATION OF STABILIZERS, OUTRIGGERS, BRIDGE AND RAMPS',
            'CHECK NON-SLIP CONDITION, RIVETS AND SECURITY',
            'CHECK CONDITION OF GUEST HAND RAILS AND TOUCH POINTS',
            'CHECK CONDITION OF HYDRAULIC SYSTEMS AND EXTENSION LOCKS',
            'CHECK STAIR SECURITY AND OPERATION',
            'CHECK CONDITION OF RIBBON CASSETTE EXTENSION',
            'CHECK STAIR ROLLS FREELY',
            'CHECK OPERATION OF FLIP STEP AND LATCH KNOBS',
            'SPRAY WD40 ON ALL HINGE POINTS',
            'GREASE ALL FITTINGS'
          ]
        },
        {
          id: 'kubota_7499',
          name: 'KUBOTA - 7499',
          category: 'VEHICLE',
          tasks: [
            'WALK AROUND - INSPECT UNIT FOR DAMAGE & CONDITION OF PROTECTIVE BUMPERS',
            'CHECK CONDITION OF TOWBAR AND/OR HITCH',
            'CHECK FUNCTION AND SECURITY OF PARK BRAKE AND ADJUST IF REQUIRED',
            'VISUALLY CHECK FOR FLUID LEAKS',
            'CHECK PRESENCE AND CONDITION OF WHEEL CHOCKS (IF REQUIRED)',
            'CHECK ALL DOORS, COVERS AND CABINETS OPERATE CORRECTLY AND LOCK/FASTEN SECURELY',
            'CHECK THAT ALL FOD IS REMOVED FROM THE UNIT',
            'CHECK SEATS AND SEAT BELTS ARE PRESENT AND IN GOOD CONDITION',
            'CHECK TIRES FOR WEAR, DAMAGE & PRESSURE (INFLATE IF NECESSARY)',
            'CHECK PRESENCE AND TORQUE OF WHEEL LUG NUTS',
            'CHECK ENGINE COMPARTMENT FOR FLUID LEAKS',
            'CHECK DRIVE AND PULLEY BELTS FOR WEAR AND CORRECT TENSION',
            'CHECK AIR FILTER CONDITION',
            'CHECK OIL',
            'CHECK TRANSMISSION FLUID',
            'CHECK COOLANT LEVEL',
            'CHECK BRAKE FLUID',
            'RUN UNIT UP TO TEMPERATURE AND OBSERVE FOR ANY ABNORMAL MECHANICAL FUNCTION',
            'CHECK ALL LIGHTS',
            'CHECK BATTERY CONDITION, VOLTAGE AND CHARGING SYSTEM',
            'CHECK OPERATION OF HORN, BACK UP BEACONS AND OTHER SAFETY DEVICES',
            'OBSERVE UNIT GAUGES FOR NORMAL OPERATION THROUGHOUT ALL MODES',
            'CHECK SERVICEABILITY OF ALL DRIVE FUNCTIONS',
            'CONFIRM BRAKE SERVICEABILITY',
            'HOUR METER READING'
          ]
        },
        {
          id: 'kubota_7500',
          name: 'KUBOTA - 7500',
          category: 'VEHICLE',
          tasks: [
            'WALK AROUND - INSPECT UNIT FOR DAMAGE & CONDITION OF PROTECTIVE BUMPERS',
            'CHECK CONDITION OF TOWBAR AND/OR HITCH',
            'CHECK FUNCTION AND SECURITY OF PARK BRAKE AND ADJUST IF REQUIRED',
            'VISUALLY CHECK FOR FLUID LEAKS',
            'CHECK PRESENCE AND CONDITION OF WHEEL CHOCKS (IF REQUIRED)',
            'CHECK ALL DOORS, COVERS AND CABINETS OPERATE CORRECTLY AND LOCK/FASTEN SECURELY',
            'CHECK THAT ALL FOD IS REMOVED FROM THE UNIT',
            'CHECK SEATS AND SEAT BELTS ARE PRESENT AND IN GOOD CONDITION',
            'CHECK TIRES FOR WEAR, DAMAGE & PRESSURE (INFLATE IF NECESSARY)',
            'CHECK PRESENCE AND TORQUE OF WHEEL LUG NUTS',
            'CHECK ENGINE COMPARTMENT FOR FLUID LEAKS',
            'CHECK DRIVE AND PULLEY BELTS FOR WEAR AND CORRECT TENSION',
            'CHECK AIR FILTER CONDITION',
            'CHECK OIL',
            'CHECK TRANSMISSION FLUID',
            'CHECK COOLANT LEVEL',
            'CHECK BRAKE FLUID',
            'RUN UNIT UP TO TEMPERATURE AND OBSERVE FOR ANY ABNORMAL MECHANICAL FUNCTION',
            'CHECK ALL LIGHTS',
            'CHECK BATTERY CONDITION, VOLTAGE AND CHARGING SYSTEM',
            'CHECK OPERATION OF HORN, BACK UP BEACONS AND OTHER SAFETY DEVICES',
            'OBSERVE UNIT GAUGES FOR NORMAL OPERATION THROUGHOUT ALL MODES',
            'CHECK SERVICEABILITY OF ALL DRIVE FUNCTIONS',
            'CONFIRM BRAKE SERVICEABILITY',
            'HOUR METER READING'
          ]
        },
        {
          id: 'lav_cart',
          name: 'LAV CART - 7316',
          category: 'LAV CART',
          tasks: [
            'WALK AROUND INSPECTION - CHECK FOR ANY DAMAGE OR MISSING PARTS',
            'CHECK TIRE PRESSURE, CONDITION & WEAR - INFLATE IF REQUIRED',
            'GENERAL INSPECTION - PAINT DECALS SAFETY MARKINGS',
            'CHECK FOR ANY LEAKS',
            'CHECK COUPLINGS HOSE AND FITTINGS',
            'LUBRICATE ALL MOVING PARTS'
          ]
        },
        {
          id: 'therm_heater_7303',
          name: 'THERM HEATER - 7303',
          category: 'HEATER/AC',
          tasks: [
            'WALK AROUND - INSPECT UNIT FOR DAMAGE & CONDITION OF PROTECTIVE BUMPERS',
            'CHECK CONDITION OF TOWBAR AND/OR HITCH',
            'CHECK FUNCTION AND SECURITY OF PARK BRAKE AND ADJUST IF REQUIRED',
            'VISUALLY CHECK FOR FLUID LEAKS',
            'CHECK FIRE EXTINGUISHER IS PRESENT AND MONTHLY INSPECTION COMPLETE',
            'CHECK PRESENCE AND CONDITION OF WHEEL CHOCKS (IF REQUIRED)',
            'CHECK ALL DOORS, COVERS AND CABINETS OPERATE CORRECTLY AND LOCK/FASTEN SECURELY',
            'CHECK TIRES FOR WEAR, DAMAGE & PRESSURE (INFLATE IF NECESSARY)',
            'CHECK PRESENCE AND TORQUE OF WHEEL LUG NUTS',
            'CHECK ENGINE COMPARTMENT FOR FLUID LEAKS',
            'CHECK DRIVE AND PULLEY BELTS FOR WEAR AND CORRECT TENSION',
            'CHECK AIR FILTER CONDITION',
            'CHECK OIL',
            'CHECK TRANSMISSION FLUID',
            'CHECK COOLANT LEVEL',
            'RUN UNIT UP TO TEMPERATURE AND OBSERVE FOR ANY ABNORMAL MECHANICAL FUNCTION',
            'CHECK ALL LIGHTS',
            'CHECK BATTERY CONDITION, VOLTAGE AND CHARGING SYSTEM',
            'OBSERVE UNIT GAUGES FOR NORMAL OPERATION THROUGHOUT ALL MODES',
            'HOUR METER READING'
          ]
        },
        {
          id: 'therm_heater_7207',
          name: 'THERM HEATER - 7207',
          category: 'HEATER/AC',
          tasks: [
            'WALK AROUND - INSPECT UNIT FOR DAMAGE & CONDITION OF PROTECTIVE BUMPERS',
            'CHECK CONDITION OF TOWBAR AND/OR HITCH',
            'CHECK FUNCTION AND SECURITY OF PARK BRAKE AND ADJUST IF REQUIRED',
            'VISUALLY CHECK FOR FLUID LEAKS',
            'CHECK FIRE EXTINGUISHER IS PRESENT AND MONTHLY INSPECTION COMPLETE',
            'CHECK PRESENCE AND CONDITION OF WHEEL CHOCKS (IF REQUIRED)',
            'CHECK ALL DOORS, COVERS AND CABINETS OPERATE CORRECTLY AND LOCK/FASTEN SECURELY',
            'CHECK TIRES FOR WEAR, DAMAGE & PRESSURE (INFLATE IF NECESSARY)',
            'CHECK PRESENCE AND TORQUE OF WHEEL LUG NUTS',
            'CHECK ENGINE COMPARTMENT FOR FLUID LEAKS',
            'CHECK DRIVE AND PULLEY BELTS FOR WEAR AND CORRECT TENSION',
            'CHECK AIR FILTER CONDITION',
            'CHECK OIL',
            'CHECK TRANSMISSION FLUID',
            'CHECK COOLANT LEVEL',
            'RUN UNIT UP TO TEMPERATURE AND OBSERVE FOR ANY ABNORMAL MECHANICAL FUNCTION',
            'CHECK ALL LIGHTS',
            'CHECK BATTERY CONDITION, VOLTAGE AND CHARGING SYSTEM',
            'OBSERVE UNIT GAUGES FOR NORMAL OPERATION THROUGHOUT ALL MODES',
            'HOUR METER READING'
          ]
        },
        {
          id: 'rectifier_7503',
          name: 'RECTIFIER - 7503',
          category: 'GROUND POWER UNIT',
          tasks: [
            'WALK AROUND - INSPECT OVERALL CONDITION, LOOK FOR DAMAGE, PROTECTIVE BUMPERS ETC.',
            'CHECK CONDITION OF TOW BAR AND SAFETY SOCK',
            'CHECK FUNCTION AND HOLDING POWER OF PARKING BRAKE - ADJUST IF NECESSARY',
            'CHECK TIRES FOR WEAR, DAMAGE AND LEAKS. INFLATE AS NECESSARY',
            'CHECK OUTPUT CABLES, PLUG END AND NOSE PINS FOR WEAR OR DAMAGE',
            'VISUALLY CHECK FOR FLUID LEAKS',
            'CHECK ALL BELTS FOR WEAR, DAMAGE AND TENSION',
            'CHECK CONDITION OF BATTERY, BLANKET AND CHARGER (IF PROVIDED)',
            'RUN UNIT UP TO TEMP AND OBSERVE FOR ANY ABNORMAL MECHANICAL FUNCTIONS',
            'OBSERVE ALL GAUGES FOR NORMAL OPERATION THROUGHOUT ALL MODES',
            'CHECK ALL LIGHTS',
            'CHECK BATTERY CONDITION, VOLTAGE AND CHARGING SYSTEM',
            'RECORD VOLTAGE OUTPUT AS SHOWN ON METER',
            'ENSURE VOLTAGE OUTPUT IS CONSTANT',
            'ENSURE CABLE ENDS ARE CLEAR OF DEBRIS, DIRT, ICE, SNOW, ETC.'
          ]
        },
        {
          id: 'hobart_gpu_7507',
          name: 'HOBART 28V GPU - 7507',
          category: 'GROUND POWER UNIT',
          tasks: [
            'WALK AROUND - INSPECT OVERALL CONDITION, LOOK FOR DAMAGE, PROTECTIVE BUMPERS ETC.',
            'CHECK CONDITION OF TOW BAR AND SAFETY SOCK',
            'CHECK FUNCTION AND HOLDING POWER OF PARKING BRAKE - ADJUST IF NECESSARY',
            'CHECK TIRES FOR WEAR, DAMAGE AND LEAKS. INFLATE AS NECESSARY',
            'CHECK OUTPUT CABLES, PLUG END AND NOSE PINS FOR WEAR OR DAMAGE',
            'VISUALLY CHECK FOR FLUID LEAKS',
            'CHECK ALL BELTS FOR WEAR, DAMAGE AND TENSION',
            'CHECK CONDITION OF BATTERY, BLANKET AND CHARGER (IF PROVIDED)',
            'RUN UNIT UP TO TEMP AND OBSERVE FOR ANY ABNORMAL MECHANICAL FUNCTIONS',
            'OBSERVE ALL GAUGES FOR NORMAL OPERATION THROUGHOUT ALL MODES',
            'CHECK ALL LIGHTS',
            'CHECK BATTERY CONDITION, VOLTAGE AND CHARGING SYSTEM',
            'RECORD VOLTAGE OUTPUT AS SHOWN ON METER',
            'ENSURE VOLTAGE OUTPUT IS CONSTANT',
            'ENSURE CABLE ENDS ARE CLEAR OF DEBRIS, DIRT, ICE, SNOW, ETC.'
          ]
        },
        {
          id: 'belt_loader_7372',
          name: 'BELT LOADER - 7372',
          category: 'MOBILE CONVEYOR BELT',
          tasks: [
            'WALK AROUND - INSPECT UNIT FOR DAMAGE AND CONDITION OF PROTECTIVE BUMPERS',
            'CHECK FUNCTION AND SECURITY OF PARK BRAKE & ADJUST IF REQUIRED',
            'VISUALLY CHECK FOR FLUID LEAKS',
            'CHECK FIRE EXTINGUISHER IS PRESENT & MONTHLY INSPECTION COMPLETE',
            'CHECK PRESENCE AND CONDITION OF WHEEL CHOCKS',
            'CHECK ENGINE COVER OPERATES CORRECTLY & SEATS SECURELY - ENSURE ENGINE INSULATION IS PRESENT',
            'CHECK THAT FOD IS REMOVED FROM THE UNIT',
            'CHECK TIRES FOR WEAR, DAMAGE AND PRESSURE (INFLATE IF NECESSARY)',
            'CHECK PRESENCE AND TORQUE WHEEL LUG NUTS',
            'CHECK ENGINE COMPARTMENT FOR FLUID LEAKS',
            'CHECK DRIVE AND PULLEY BELTS FOR WEAR AND CORRECT TENSION',
            'CHECK AIR FILTER CONDITION',
            'CHECK OIL',
            'CHECK TRANSMISSION FLUID',
            'CHECK HYDRAULIC FLUID',
            'CHECK COOLANT LEVEL',
            'RUN UNIT UP TO TEMPERATURE AND OBSERVE FOR ANY ABNORMAL MECHANICAL FUNCTION',
            'CHECK THAT HYDRAULIC BELT AND LIFT FUNCTIONS ARE SERVICEABLE',
            'CHECK ALL LIGHTS',
            'CHECK BATTERY CONDITIONS, VOLTAGE AND CHARGING SYSTEM',
            'CHECK OPERATION OF HORN, BACKUP BEACONS & OTHER SAFETY DEVICES',
            'OBSERVE UNIT GAUGES FOR NORMAL OPERATIONS THROUGHOUT ALL LOADS',
            'CHECK SERVICEABILITY OF ALL DRIVE FUNCTIONS',
            'CHECK CONDITION & ALIGNMENT OF CONVEYOR BELTING',
            'HOUR METER READING'
          ]
        },
        {
          id: 'deice_truck_7465',
          name: 'DEICE TRUCK - 7465 (SEASONAL)',
          category: 'DEICE VEHICLE',
          seasonal: true,
          tasks: [
            'WALK AROUND - INSPECT UNIT FOR DAMAGE & CONDITION OF PROTECTIVE BUMPERS',
            'CHECK CONDITION OF TOWBAR AND/OR HITCH',
            'CHECK FUNCTION AND SECURITY OF PARK BRAKE AND ADJUST IF REQUIRED',
            'VISUALLY CHECK FOR FLUID LEAKS',
            'CHECK PRESENCE AND CONDITION OF WHEEL CHOCKS (IF REQUIRED)',
            'CHECK ALL DOORS, COVERS AND CABINETS OPERATE CORRECTLY AND LOCK/FASTEN SECURELY',
            'CHECK THAT ALL FOD IS REMOVED FROM THE UNIT',
            'CHECK SEATS AND SEAT BELTS ARE PRESENT AND IN GOOD CONDITION',
            'CHECK TIRES FOR WEAR, DAMAGE & PRESSURE (INFLATE IF NECESSARY)',
            'CHECK PRESENCE AND TORQUE OF WHEEL LUG NUTS',
            'CHECK ENGINE COMPARTMENT FOR FLUID LEAKS',
            'CHECK DRIVE AND PULLEY BELTS FOR WEAR AND CORRECT TENSION',
            'CHECK AIR FILTER CONDITION',
            'CHECK OIL',
            'CHECK TRANSMISSION FLUID',
            'CHECK COOLANT LEVEL',
            'CHECK BRAKE FLUID',
            'RUN UNIT UP TO TEMPERATURE AND OBSERVE FOR ANY ABNORMAL MECHANICAL FUNCTION',
            'CHECK ALL LIGHTS',
            'CHECK BATTERY CONDITION, VOLTAGE AND CHARGING SYSTEM',
            'CHECK OPERATION OF HORN, BACK UP BEACONS AND OTHER SAFETY DEVICES',
            'OBSERVE UNIT GAUGES FOR NORMAL OPERATION THROUGHOUT ALL MODES',
            'CHECK SERVICEABILITY OF ALL DRIVE FUNCTIONS',
            'CONFIRM BRAKE SERVICEABILITY',
            'CHECK DEICE SPRAY SYSTEM OPERATION',
            'CHECK DEICE FLUID TANK LEVEL',
            'INSPECT SPRAY NOZZLES FOR CLOGS OR DAMAGE',
            'HOUR METER READING'
          ]
        },
        {
          id: 'deice_truck_rear_7465',
          name: 'DEICE TRUCK REAR - 7465 (SEASONAL)',
          category: 'DEICE VEHICLE',
          seasonal: true,
          tasks: [
            'CHECK REAR PLATFORM CONDITION AND SAFETY RAILINGS',
            'INSPECT REAR DEICE SPRAY ARMS AND NOZZLES',
            'CHECK DEICE FLUID LINES FOR LEAKS OR DAMAGE',
            'VERIFY REAR SPRAY SYSTEM OPERATION',
            'CHECK CONDITION OF REAR WALKWAY SURFACES',
            'INSPECT SAFETY EQUIPMENT AND HARNESS POINTS',
            'CHECK REAR LIGHTING AND WARNING BEACONS',
            'VERIFY COMMUNICATION SYSTEM BETWEEN FRONT AND REAR',
            'CHECK EMERGENCY SHUT-OFF CONTROLS',
            'INSPECT STORAGE COMPARTMENTS AND TOOL SECURING'
          ]
        },
        {
          id: 'cart_covered',
          name: 'CART, COVERED - 7410',
          category: 'TOWABLE CART',
          tasks: [
            'WALK AROUND - INSPECT UNIT FOR DAMAGE & CONDITION OF PROTECTIVE BUMPERS',
            'CHECK CONDITION OF TOW BAR / HITCH',
            'CHECK FUNCTION & SECURITY OF PARK BRAKE & ADJUST IF REQUIRED',
            'CHECK TIRES FOR WEAR, DAMAGE & PRESSURE (INFLATE IF NECESSARY)',
            'CHECK PRESENCE & TORQUE OF WHEEL LUG NUTS',
            'CHECK SAFETY MARKING AND OR DEVICES',
            'CONFIRM BRAKE SERVICEABILITY'
          ]
        },
        {
          id: 'cart_open',
          name: 'CART, OPEN - 7408',
          category: 'TOWABLE CART',
          tasks: [
            'WALK AROUND - INSPECT UNIT FOR DAMAGE & CONDITION OF PROTECTIVE BUMPERS',
            'CHECK CONDITION OF TOW BAR / HITCH',
            'CHECK FUNCTION & SECURITY OF PARK BRAKE & ADJUST IF REQUIRED',
            'CHECK TIRES FOR WEAR, DAMAGE & PRESSURE (INFLATE IF NECESSARY)',
            'CHECK PRESENCE & TORQUE OF WHEEL LUG NUTS',
            'CHECK SAFETY MARKING AND OR DEVICES',
            'CONFIRM BRAKE SERVICEABILITY'
          ]
        }
      ],
      'default': [
        {
          id: 'stairs_general',
          name: 'Portable Stairs',
          category: 'PORTABLE STAIR',
          tasks: [
            'WALK AROUND - COMPLETE VISUAL INSPECTION FOR ANY DAMAGE',
            'CHECK FOR MISSING OR LOOSE NUTS, BOLTS OR PARTS',
            'CHECK TIRE PRESSURE AND CONDITION',
            'CHECK BRAKE OPERATION & CONDITION',
            'CHECK STAIR OPERATION AND SECURITY',
            'GREASE ALL FITTINGS'
          ]
        },
        {
          id: 'baggage_cart',
          name: 'Baggage Cart',
          category: 'TOWABLE CART',
          tasks: [
            'WALK AROUND - INSPECT FOR DAMAGE',
            'CHECK TOW BAR/HITCH CONDITION',
            'CHECK BRAKE FUNCTION',
            'CHECK TIRE CONDITION AND PRESSURE',
            'CHECK SAFETY MARKINGS'
          ]
        },
        {
          id: 'ground_power',
          name: 'Ground Power Unit',
          category: 'GROUND POWER UNIT',
          tasks: [
            'WALK AROUND INSPECTION',
            'CHECK TOW BAR CONDITION',
            'CHECK PARKING BRAKE',
            'CHECK TIRES AND PRESSURE',
            'CHECK OUTPUT CABLES',
            'CHECK FUEL LEVEL',
            'CHECK FOR FLUID LEAKS'
          ]
        },
        {
          id: 'belt_loader_gen',
          name: 'Belt Loader',
          category: 'MOBILE CONVEYOR BELT',
          tasks: [
            'WALK AROUND INSPECTION',
            'CHECK BRAKE FUNCTION',
            'CHECK FOR FLUID LEAKS',
            'CHECK TIRE CONDITION',
            'CHECK BELT ALIGNMENT',
            'CHECK SAFETY DEVICES'
          ]
        }
      ]
    };

    // Email recipients by station
    const emailRecipients = {
      'YBR': [
        'sean.davies@maintair.com',
        'john.marshall@maintair.com', 
        'john.currie@maintair.com',
        'eric.cline@maintair.com',
        'joseph.hunter@maintair.com',
        'sergio.martinez@maintair.com'
      ],
      'default': [
        'sean.davies@maintair.com',
        'john.marshall@maintair.com',
        'john.currie@maintair.com',
        'eric.cline@maintair.com'
      ]
    };

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      initializePage();
    });

    function initializePage() {
      // Get user info from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      currentUser = decodeURIComponent(urlParams.get('user') || '');
      currentStation = decodeURIComponent(urlParams.get('station') || '');
      isManagerAccess = urlParams.get('manager') === 'true';

      if (!currentUser) {
        alert('Authentication required. Redirecting to home page.');
        window.location.href = 'index.html';
        return;
      }

      // Update display
      document.getElementById('inspectorName').textContent = currentUser.split('@')[0];
      
      if (isManagerAccess) {
        // Show station selector for managers
        document.getElementById('stationSelectGroup').style.display = 'block';
        document.getElementById('stationCode').textContent = 'Manager Access';
      } else {
        // Set station for regular users
        document.getElementById('stationCode').textContent = currentStation;
        loadEquipment(currentStation);
      }

      // Setup station selector for managers
      document.getElementById('stationSelect').addEventListener('change', function() {
        if (this.value) {
          currentStation = this.value;
          document.getElementById('stationCode').textContent = currentStation;
          loadEquipment(currentStation);
        }
      });
    }

    function loadEquipment(station) {
      const equipment = stationEquipment[station] || stationEquipment['default'];
      const container = document.getElementById('equipmentList');
      container.innerHTML = '';

      equipment.forEach(item => {
        equipmentData[item.id] = {
          ...item,
          status: 'pending',
          tasks: item.tasks.map(task => ({ text: task, completed: false })),
          skipped: false,
          skipReason: ''
        };

        const equipmentDiv = createEquipmentElement(item);
        container.appendChild(equipmentDiv);
      });

      updateProgress();
    }

    function createEquipmentElement(equipment) {
      const div = document.createElement('div');
      div.className = equipment.seasonal ? 'equipment-selector seasonal-equipment' : 'equipment-selector';
      div.innerHTML = `
        <div class="equipment-header" onclick="toggleEquipment('${equipment.id}')">
          <span>${equipment.name}</span>
          <span>
            <span class="equipment-status status-pending" id="status-${equipment.id}">Pending</span>
            <span>‚ñº</span>
          </span>
        </div>
        <div class="equipment-content" id="content-${equipment.id}">
          <div class="task-list">
            ${equipment.tasks.map((task, index) => `
              <div class="task-item">
                <input type="checkbox" class="task-checkbox" id="task-${equipment.id}-${index}" 
                       onchange="updateTask('${equipment.id}', ${index})">
                <span class="task-text">${task}</span>
              </div>
            `).join('')}
          </div>
          
          <div class="skip-equipment">
            <label>
              <input type="checkbox" id="skip-${equipment.id}" onchange="toggleSkip('${equipment.id}')">
              Skip this equipment ${equipment.seasonal ? '(seasonal/not ready for PMI)' : '(not ready for PMI)'}
            </label>
            <div class="skip-reason" id="skip-reason-${equipment.id}">
              <label>Reason for skipping:</label>
              <textarea placeholder="Explain why this equipment is being skipped..." 
                        onchange="updateSkipReason('${equipment.id}')" rows="2"></textarea>
            </div>
          </div>
        </div>
      `;
      return div;
    }

    function toggleEquipment(equipmentId) {
      const content = document.getElementById(`content-${equipmentId}`);
      content.classList.toggle('active');
      
      if (!inspectionStarted && content.classList.contains('active')) {
        startInspection();
      }
    }

    function startInspection() {
      if (!inspectionStarted) {
        inspectionStarted = true;
        startTime = new Date();
        document.getElementById('startTime').textContent = startTime.toLocaleTimeString();
        document.getElementById('submitBtn').disabled = false;
      }
    }

    function updateTask(equipmentId, taskIndex) {
      const checkbox = document.getElementById(`task-${equipmentId}-${taskIndex}`);
      equipmentData[equipmentId].tasks[taskIndex].completed = checkbox.checked;
      updateEquipmentStatus(equipmentId);
      updateProgress();
    }

    function toggleSkip(equipmentId) {
      const skipCheckbox = document.getElementById(`skip-${equipmentId}`);
      const skipReason = document.getElementById(`skip-reason-${equipmentId}`);
      
      equipmentData[equipmentId].skipped = skipCheckbox.checked;
      
      if (skipCheckbox.checked) {
        skipReason.classList.add('show');
        // Uncheck all tasks when skipping
        equipmentData[equipmentId].tasks.forEach((task, index) => {
          const taskCheckbox = document.getElementById(`task-${equipmentId}-${index}`);
          taskCheckbox.checked = false;
          task.completed = false;
          taskCheckbox.disabled = true;
        });
      } else {
        skipReason.classList.remove('show');
        // Re-enable all tasks
        equipmentData[equipmentId].tasks.forEach((task, index) => {
          const taskCheckbox = document.getElementById(`task-${equipmentId}-${index}`);
          taskCheckbox.disabled = false;
        });
      }
      
      updateEquipmentStatus(equipmentId);
      updateProgress();
    }

    function updateSkipReason(equipmentId) {
      const textarea = event.target;
      equipmentData[equipmentId].skipReason = textarea.value;
    }

    function updateEquipmentStatus(equipmentId) {
      const equipment = equipmentData[equipmentId];
      const statusElement = document.getElementById(`status-${equipmentId}`);
      
      if (equipment.skipped) {
        equipment.status = 'skipped';
        statusElement.textContent = 'Skipped';
        statusElement.className = 'equipment-status status-skipped';
      } else {
        const completedTasks = equipment.tasks.filter(task => task.completed).length;
        const totalTasks = equipment.tasks.length;
        
        if (completedTasks === totalTasks && totalTasks > 0) {
          equipment.status = 'completed';
          statusElement.textContent = 'Completed';
          statusElement.className = 'equipment-status status-completed';
        } else {
          equipment.status = 'pending';
          statusElement.textContent = `${completedTasks}/${totalTasks}`;
          statusElement.className = 'equipment-status status-pending';
        }
      }
    }

    function updateProgress() {
      const equipmentIds = Object.keys(equipmentData);
      const completedEquipment = equipmentIds.filter(id => 
        equipmentData[id].status === 'completed' || equipmentData[id].status === 'skipped'
      ).length;
      
      const progressPercent = equipmentIds.length > 0 ? Math.round((completedEquipment / equipmentIds.length) * 100) : 0;
      
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      
      progressBar.style.width = `${progressPercent}%`;
      progressBar.textContent = `${progressPercent}% Complete`;
      progressText.textContent = `${progressPercent}% Complete (${completedEquipment}/${equipmentIds.length} items)`;
    }

    function submitInspection() {
      if (!inspectionStarted) {
        alert('Please start the inspection by selecting equipment first.');
        return;
      }

      const endTime = new Date();
      const incompletedEquipment = Object.keys(equipmentData).filter(id => 
        equipmentData[id].status === 'pending'
      );

      if (incompletedEquipment.length > 0) {
        const equipmentNames = incompletedEquipment.map(id => equipmentData[id].name);
        const confirm = window.confirm(
          `The following equipment inspections are incomplete:\n${equipmentNames.join('\n')}\n\nDo you want to submit anyway?`
        );
        if (!confirm) return;
      }

      // Generate inspection report
      const report = generateInspectionReport(endTime);
      
      // Get recipients
      const recipients = emailRecipients[currentStation] || emailRecipients['default'];
      
      // Create mailto link
      const subject = encodeURIComponent(`PMI Report - ${currentStation} - ${new Date().toDateString()}`);
      const body = encodeURIComponent(report);
      const mailto = `mailto:${recipients.join(',')}?subject=${subject}&body=${body}`;
      
      // Open email client
      window.open(mailto);
      
      alert('Inspection submitted successfully! Email client opened with report.');
    }

    function generateInspectionReport(endTime) {
      const duration = Math.round((endTime - startTime) / 60000); // minutes
      
      let report = `MONTHLY PREVENTIVE MAINTENANCE INSPECTION REPORT\n`;
      report += `===============================================\n\n`;
      report += `Station: ${currentStation}\n`;
      report += `Inspector: ${currentUser}\n`;
      report += `Date: ${new Date().toDateString()}\n`;
      report += `Start Time: ${startTime.toLocaleTimeString()}\n`;
      report += `End Time: ${endTime.toLocaleTimeString()}\n`;
      report += `Duration: ${duration} minutes\n\n`;

      report += `EQUIPMENT INSPECTIONS:\n`;
      report += `=====================\n\n`;

      Object.keys(equipmentData).forEach(id => {
        const equipment = equipmentData[id];
        report += `${equipment.name} (${equipment.category})\n`;
        if (equipment.seasonal) {
          report += `*** SEASONAL EQUIPMENT ***\n`;
        }
        report += `Status: ${equipment.status.toUpperCase()}\n`;
        
        if (equipment.skipped) {
          report += `Reason for skipping: ${equipment.skipReason || 'Not specified'}\n\n`;
        } else {
          const completedTasks = equipment.tasks.filter(task => task.completed).length;
          report += `Tasks completed: ${completedTasks}/${equipment.tasks.length}\n`;
          
          equipment.tasks.forEach((task, index) => {
            report += `  ${task.completed ? '[‚úì]' : '[ ]'} ${task.text}\n`;
          });
          report += `\n`;
        }
      });

      const additionalNotes = document.getElementById('additionalNotes').value.trim();
      if (additionalNotes) {
        report += `ADDITIONAL NOTES:\n`;
        report += `================\n`;
        report += `${additionalNotes}\n\n`;
      }

      const completedCount = Object.values(equipmentData).filter(eq => eq.status === 'completed').length;
      const skippedCount = Object.values(equipmentData).filter(eq => eq.status === 'skipped').length;
      const totalCount = Object.keys(equipmentData).length;

      report += `SUMMARY:\n`;
      report += `========\n`;
      report += `Total Equipment: ${totalCount}\n`;
      report += `Completed: ${completedCount}\n`;
      report += `Skipped: ${skippedCount}\n`;
      report += `Pending: ${totalCount - completedCount - skippedCount}\n\n`;

      report += `Generated by RAMPSECURE PMI System\n`;
      report += `Maintair Aviation Services Ltd.`;

      return report;
    }

    function createEDR() {
      // Redirect to EDR page with current context
      const params = new URLSearchParams();
      params.set('user', encodeURIComponent(currentUser));
      params.set('station', encodeURIComponent(currentStation));
      params.set('manager', isManagerAccess ? 'true' : 'false');
      params.set('from', 'pmi');
      
      window.location.href = `edr.html?${params.toString()}`;
    }

    function saveDraft() {
      const draftData = {
        user: currentUser,
        station: currentStation,
        startTime: startTime,
        equipmentData: equipmentData,
        additionalNotes: document.getElementById('additionalNotes').value,
        timestamp: new Date().toISOString()
      };

      // Save to session storage
      sessionStorage.setItem('pmiDraft', JSON.stringify(draftData));
      alert('Draft saved successfully! You can continue this inspection later.');
    }

    function loadDraft() {
      const draftData = sessionStorage.getItem('pmiDraft');
      if (draftData) {
        try {
          const data = JSON.parse(draftData);
          if (data.user === currentUser && data.station === currentStation) {
            if (confirm('Found a saved draft from ' + new Date(data.timestamp).toLocaleString() + '. Load it?')) {
              equipmentData = data.equipmentData;
              startTime = new Date(data.startTime);
              inspectionStarted = true;
              
              document.getElementById('startTime').textContent = startTime.toLocaleTimeString();
              document.getElementById('additionalNotes').value = data.additionalNotes || '';
              document.getElementById('submitBtn').disabled = false;
              
              // Update UI
              Object.keys(equipmentData).forEach(id => {
                const equipment = equipmentData[id];
                equipment.tasks.forEach((task, index) => {
                  const checkbox = document.getElementById(`task-${id}-${index}`);
                  if (checkbox) checkbox.checked = task.completed;
                });
                
                if (equipment.skipped) {
                  const skipCheckbox = document.getElementById(`skip-${id}`);
                  if (skipCheckbox) {
                    skipCheckbox.checked = true;
                    const skipReason = document.getElementById(`skip-reason-${id}`);
                    if (skipReason) {
                      skipReason.classList.add('show');
                      const textarea = skipReason.querySelector('textarea');
                      if (textarea) textarea.value = equipment.skipReason || '';
                    }
                  }
                }
                
                updateEquipmentStatus(id);
              });
              
              updateProgress();
              sessionStorage.removeItem('pmiDraft');
            }
          }
        } catch (e) {
          console.error('Error loading draft:', e);
        }
      }
    }

    function goBack() {
      const params = new URLSearchParams();
      params.set('user', encodeURIComponent(currentUser));
      params.set('station', encodeURIComponent(currentStation || ''));
      params.set('manager', isManagerAccess ? 'true' : 'false');
      params.set('return', 'true');
      
      window.location.href = `index.html?${params.toString()}`;
    }

    // Load draft on page load if available
    window.addEventListener('load', function() {
      setTimeout(loadDraft, 1000);
    });
  </script>
</body>
</html>