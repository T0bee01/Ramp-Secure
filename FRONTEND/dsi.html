<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily Safety Inspection (DSI) - RAMPSECURE</title>
  
  <style>
    :root{
      --red:#C62828;
      --red-dark:#A31F1F;
      --black:#0E0E0E;
      --white:#FFFFFF;
      --gray:#f5f5f5;
      --light-gray:#fafafa;
      --green:#4CAF50;
      --orange:#FF9800;
      --blue:#2196F3;
    }
    
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0}
    body{
      font-family: Arial, Helvetica, sans-serif;
      background:var(--red);
      color:var(--black);
      padding:20px;
    }
    
    .container{
      max-width:1200px;
      margin:0 auto;
      background:var(--white);
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,0.2);
      overflow:hidden;
    }
    
    .header{
      background:linear-gradient(135deg, var(--red) 0%, var(--red-dark) 100%);
      color:var(--white);
      padding:20px 30px;
      position:relative;
    }
    
    .header h1{
      margin:0;
      font-size:28px;
      font-weight:900;
    }
    
    .header p{
      margin:5px 0 0;
      opacity:0.9;
      font-size:14px;
    }
    
    .emergency-info{
      background:var(--red-dark);
      padding:10px 30px;
      font-size:14px;
      font-weight:600;
    }
    
    .form-content{
      padding:30px;
    }
    
    .form-section{
      margin-bottom:30px;
      border:2px solid #e0e0e0;
      border-radius:12px;
      overflow:hidden;
    }
    
    .section-header{
      background:var(--light-gray);
      padding:15px 20px;
      border-bottom:2px solid #e0e0e0;
      font-weight:700;
      font-size:16px;
      color:var(--black);
    }
    
    .section-content{
      padding:20px;
    }
    
    .form-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:20px;
      margin-bottom:20px;
    }
    
    .form-group{
      display:flex;
      flex-direction:column;
    }
    
    .form-group label{
      font-weight:600;
      margin-bottom:5px;
      color:var(--black);
    }
    
    .form-group input, .form-group select, .form-group textarea{
      padding:12px;
      border:2px solid #ddd;
      border-radius:8px;
      font-size:14px;
      transition:border-color 0.2s ease;
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus{
      outline:none;
      border-color:var(--red);
    }

    .time-display{
      background:var(--light-gray);
      padding:12px;
      border:2px solid #ddd;
      border-radius:8px;
      font-weight:600;
      color:var(--black);
    }
    
    .equipment-table{
      width:100%;
      border-collapse:collapse;
      margin-top:20px;
      background:var(--white);
    }
    
    .equipment-table th{
      background:var(--red);
      color:var(--white);
      padding:12px 8px;
      text-align:center;
      font-weight:700;
      font-size:12px;
      position:sticky;
      top:0;
      z-index:10;
    }
    
    .equipment-table td{
      padding:10px 8px;
      text-align:center;
      border:1px solid #ddd;
      vertical-align:middle;
    }
    
    .equipment-table tbody tr:nth-child(even){
      background:#f9f9f9;
    }
    
    .equipment-table tbody tr:hover{
      background:#f0f0f0;
    }
    
    .equipment-name{
      text-align:left !important;
      font-weight:600;
      color:var(--black);
      min-width:120px;
    }
    
    .equipment-number{
      font-weight:500;
      color:#666;
    }
    
    .fuel-select{
      width:60px;
      padding:6px;
      border:1px solid #ddd;
      border-radius:4px;
      text-align:center;
      font-weight:600;
    }
    
    .fuel-0{background:#ff4444; color:white}
    .fuel-1{background:#ff8800; color:white}
    .fuel-2{background:#ffaa00; color:white}
    .fuel-3{background:#88cc00; color:white}
    .fuel-4{background:#44cc44; color:white}
    
    .battery-input{
      width:70px;
      padding:6px;
      border:1px solid #ddd;
      border-radius:4px;
      text-align:center;
    }
    
    .initials-input{
      width:50px;
      padding:6px;
      text-align:center;
      font-weight:600;
      text-transform:uppercase;
    }
    
    .comment-btn{
      background:var(--blue);
      color:white;
      border:none;
      padding:6px 10px;
      border-radius:4px;
      cursor:pointer;
      font-size:12px;
      margin-right:5px;
    }
    
    .comment-btn:hover{
      background:#1976D2;
    }
    
    .comment-btn.has-comment{
      background:var(--orange);
    }
    
    .na-cell{
      background:#333 !important;
      color:white;
      font-weight:600;
    }
    
    .gpu-table{
      width:100%;
      border-collapse:collapse;
      margin-top:15px;
    }
    
    .gpu-table th, .gpu-table td{
      padding:12px;
      border:1px solid #ddd;
      text-align:left;
    }
    
    .gpu-table th{
      background:var(--red);
      color:var(--white);
      font-weight:700;
    }
    
    .voltage-input{
      width:80px;
      text-align:center;
      padding:6px;
    }
    
    .action-buttons{
      display:flex;
      gap:15px;
      justify-content:center;
      margin-top:30px;
      padding-top:20px;
      border-top:2px solid #e0e0e0;
    }
    
    .btn{
      padding:15px 30px;
      border:none;
      border-radius:8px;
      font-weight:700;
      font-size:16px;
      cursor:pointer;
      transition:all 0.2s ease;
    }
    
    .btn-primary{
      background:var(--green);
      color:white;
    }
    
    .btn-primary:hover{
      background:#45a049;
      transform:translateY(-2px);
    }
    
    .btn-warning{
      background:var(--orange);
      color:white;
    }
    
    .btn-warning:hover{
      background:#f57c00;
      transform:translateY(-2px);
    }
    
    .btn-secondary{
      background:#666;
      color:white;
    }
    
    .btn-secondary:hover{
      background:#555;
      transform:translateY(-2px);
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: var(--white);
      margin: 15% auto;
      padding: 20px;
      border-radius: 12px;
      width: 80%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: var(--red);
    }

    .modal h2 {
      color: var(--red);
      margin-top: 0;
    }

    .modal textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      resize: vertical;
    }

    .modal-buttons {
      text-align: right;
      margin-top: 15px;
    }

    .modal-buttons button {
      margin-left: 10px;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    
    @media (max-width: 768px) {
      .form-grid{
        grid-template-columns:1fr;
      }
      
      .equipment-table{
        font-size:12px;
      }
      
      .equipment-table th, .equipment-table td{
        padding:8px 4px;
      }
      
      .action-buttons{
        flex-direction:column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="stationTitle">Ground Support Equipment (GSE)</h1>
      <p id="stationSubtitle">DAILY Safety Inspection (DSI)</p>
      <div style="position:absolute; top:20px; right:30px; font-size:14px;">
        Updated: <span id="currentDate"></span>
      </div>
    </div>
    
    <div class="emergency-info">
      GSE Emergencies - (807) 355-6015
    </div>
    
    <div class="form-content">
      <!-- Inspection Details Section -->
      <div class="form-section">
        <div class="section-header">Inspection Details</div>
        <div class="section-content">
          <div class="form-grid">
            <div class="form-group">
              <label for="station">Station</label>
              <select id="station" onchange="changeStation()" required>
                <option value="">Select Station</option>
                <option value="YQT">Thunder Bay (YQT)</option>
                <option value="YBR">Brandon (YBR)</option>
                <option value="YFC">Fredericton (YFC)</option>
                <option value="YTS">Timmins (YTS)</option>
                <option value="YQG">Windsor (YQG)</option>
                <option value="YSJ">Saint John (YSJ)</option>
              </select>
            </div>
            <div class="form-group">
              <label for="inspector">Inspected By</label>
              <input type="text" id="inspector" placeholder="Inspector Name" onfocus="startTimer()" required>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>Start Time (Auto)</label>
              <div id="startTimeDisplay" class="time-display">Not Started</div>
            </div>
            <div class="form-group">
              <label>End Time (Auto)</label>
              <div id="endTimeDisplay" class="time-display">Not Completed</div>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="inspectionDate">Date</label>
              <input type="date" id="inspectionDate" required>
            </div>
            <div class="form-group">
              <label for="temperature">Temperature (Â°C)</label>
              <input type="number" id="temperature" placeholder="e.g., -15">
            </div>
          </div>
        </div>
      </div>

      <!-- Equipment Inspection Section -->
      <div class="form-section" id="equipmentSection" style="display:none;">
        <div class="section-header">Equipment Inspection</div>
        <div class="section-content">
          <p><strong>INSPECT:</strong> Brakes, Hand brake, Chocks, Headlight(s), Reverse light(s), Reverse beeper, Horn, Tires, Hitches, Hoses, Ducts, Connections, Safety sock, Fuel, Battery, Oil, Coolant, Fire extinguisher, and Seat belts.</p>
          <p style="color:var(--red); font-weight:600;">Report any Visible Leaks or Damage. Equipment Deficiency Reports (EDR) must be submitted for any concerns.</p>
          
          <div style="overflow-x:auto;">
            <table class="equipment-table">
              <thead>
                <tr>
                  <th>Equipment</th>
                  <th>#</th>
                  <th>Fuel Level</th>
                  <th>Battery (V)</th>
                  <th>Oil</th>
                  <th>ATF/HYD</th>
                  <th>Coolant</th>
                  <th>Brake</th>
                  <th>Fire Ext Check</th>
                  <th>Unit Started</th>
                  <th>Remove FOD</th>
                  <th>Safe for Service</th>
                  <th>EDR/Tag Out</th>
                  <th>Comments</th>
                  <th>Initials</th>
                </tr>
              </thead>
              <tbody id="equipmentTableBody">
                <!-- Equipment rows will be generated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- GPU Inspection Section -->
      <div class="form-section" id="gpuSection" style="display:none;">
        <div class="section-header"> GPU Inspection</div>
        <div class="section-content">
          <!-- GPU DSI Table (horizontal like equipment) -->
          <div style="overflow-x:auto; margin-bottom:30px;">
            <table class="equipment-table" id="gpuDSITable">
              <thead>
                <tr>
                  <th>GPU Unit</th>
                  <th>#</th>
                  <th>Fuel Level</th>
                  <th>Battery (V)</th>
                  <th>Oil</th>
                  <th>ATF/HYD</th>
                  <th>Coolant</th>
                  <th>Brake</th>
                  <th>Fire Ext Check</th>
                  <th>Unit Started</th>
                  <th>Remove FOD</th>
                  <th>Safe for Service</th>
                  <th>EDR/Tag Out</th>
                  <th>Comments</th>
                  <th>Initials</th>
                </tr>
              </thead>
              <tbody id="gpuDSITableBody">
                <!-- GPU DSI rows will be generated by JavaScript -->
              </tbody>
            </table>
          </div>
          <!-- Original GPU inspection table -->
          <table class="gpu-table">
            <thead>
              <tr>
                <th>Inspection Item</th>
                <th id="gpuCol1">GPU 1</th>
                <th id="gpuCol2">GPU 2</th>
                <th id="gpuCol3">GPU 3</th>
                <th id="gpuCol4">GPU 4</th>
              </tr>
            </thead>
            <tbody id="gpuTableBody">
              <!-- GPU inspection rows will be generated by JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Additional Notes -->
      <div class="form-section" id="notesSection" style="display:none;">
        <div class="section-header">Additional Notes & Comments</div>
        <div class="section-content">
          <div class="form-group">
            <textarea id="additionalNotes" rows="4" placeholder="Enter any additional observations, concerns, or notes about the inspection..."></textarea>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons" id="actionButtons" style="display:none;">
        <button class="btn btn-primary" onclick="submitDSI()">Submit DSI Report</button>
        <button class="btn btn-warning" onclick="createEDR()">Create EDR</button>
        <button class="btn btn-secondary" onclick="saveDraft()">Save Draft</button>
        <button class="btn btn-secondary" onclick="goBack()">Back to Main</button>
      </div>
    </div>
  </div>

  <!-- Comment Modal -->
  <div id="commentModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeCommentModal()">&times;</span>
      <h2>Equipment Comment</h2>
      <p id="modalEquipmentName"></p>
      <textarea id="commentText" rows="4" placeholder="Enter your comment or notes about this equipment..."></textarea>
      <div class="modal-buttons">
        <button onclick="closeCommentModal()" style="background:#666; color:white;">Cancel</button>
        <button onclick="saveComment()" style="background:var(--red); color:white;">Save Comment</button>
      </div>
    </div>
  </div>

  <script>
    const stationConfigs = {
      YBR: {
        name: "Brandon (YBR)",
        equipment: [
          { name: "KUBOTA", number: "7499", type: "4", hasOil: true, hasATF: true, hasCoolant: true, hasBrake: true, hasFuel: true, hasBattery: true },
          { name: "KUBOTA", number: "7500", type: "4", hasOil: true, hasATF: true, hasCoolant: true, hasBrake: true, hasFuel: true, hasBattery: true },
          { name: "THERM HEATER (Seasonal)", number: "7303", type: "3", hasOil: true, hasATF: true, hasCoolant: true, hasBrake: false, hasFuel: true, hasBattery: true },
          { name: "THERM HEATER (Seasonal)", number: "7207", type: "3", hasOil: true, hasATF: true, hasCoolant: true, hasBrake: false, hasFuel: true, hasBattery: true },
          { name: "BELT LOADER", number: "7372", type: "4", hasOil: true, hasATF: true, hasCoolant: false, hasBrake: true, hasFuel: true, hasBattery: true },
          { name: "DEICE TRUCK (Seasonal)", number: "7465", type: "3", hasOil: true, hasATF: true, hasCoolant: true, hasBrake: true, hasFuel: true, hasBattery: true },
          { name: "DEICE TRUCK REAR", number: "7465", type: "3", hasOil: true, hasATF: false, hasCoolant: true, hasBrake: false, hasFuel: true, hasBattery: true }
        ],
        gpuEquipment: [
          { name: "RECTIFIER", number: "7503" },
          { name: "HOBART 26V GPU", number: "7307" }
        ]
      },
      YQT: {
        name: "Thunder Bay (YQT)",
        equipment: [
          { name: "KUBOTA", number: "8001", type: "4", hasOil: true, hasATF: true, hasCoolant: true, hasBrake: true, hasFuel: true, hasBattery: true },
          { name: "BELT LOADER", number: "8002", type: "4", hasOil: true, hasATF: true, hasCoolant: false, hasBrake: true, hasFuel: true, hasBattery: true }
        ],
        gpuEquipment: [
          { name: "GPU UNIT", number: "8100" }
        ]
      },
      YFC: {
        name: "Fredericton (YFC)", 
        equipment: [
          { name: "KUBOTA", number: "9001", type: "4", hasOil: true, hasATF: true, hasCoolant: true, hasBrake: true, hasFuel: true, hasBattery: true }
        ],
        gpuEquipment: []
      },
      YTS: {
        name: "Timmins (YTS)",
        equipment: [
          { name: "KUBOTA", number: "9501", type: "4", hasOil: true, hasATF: true, hasCoolant: true, hasBrake: true, hasFuel: true, hasBattery: true }
        ],
        gpuEquipment: []
      },
      YQG: {
        name: "Windsor (YQG)",
        equipment: [
          { name: "KUBOTA", number: "9701", type: "4", hasOil: true, hasATF: true, hasCoolant: true, hasBrake: true, hasFuel: true, hasBattery: true }
        ],
        gpuEquipment: []
      },
      YSJ: {
        name: "Saint John (YSJ)",
        equipment: [
          { name: "KUBOTA", number: "9801", type: "4", hasOil: true, hasATF: true, hasCoolant: true, hasBrake: true, hasFuel: true, hasBattery: true }
        ],
        gpuEquipment: []
      }
    };

    let startTime = null;
    let currentStation = '';
    let equipmentComments = {};
    let currentCommentEquipment = '';

    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('currentDate').textContent = new Date().toLocaleDateString();
      document.getElementById('inspectionDate').value = new Date().toISOString().split('T')[0];
    });

    function changeStation() {
      const station = document.getElementById('station').value;
      currentStation = station;
      if (station && stationConfigs[station]) {
        const config = stationConfigs[station];
        document.getElementById('stationTitle').textContent = `Ground Support Equipment (GSE) - ${config.name}`;
        document.getElementById('equipmentSection').style.display = 'block';
        document.getElementById('notesSection').style.display = 'block';
        document.getElementById('actionButtons').style.display = 'flex';
        generateEquipmentTable(config.equipment);
        if (config.gpuEquipment && config.gpuEquipment.length > 0) {
          generateGPUDSITable(config.gpuEquipment);
          generateGPUSection(config.gpuEquipment);
          document.getElementById('gpuSection').style.display = 'block';
        } else {
          document.getElementById('gpuSection').style.display = 'none';
        }
      } else {
        document.getElementById('equipmentSection').style.display = 'none';
        document.getElementById('gpuSection').style.display = 'none';
        document.getElementById('notesSection').style.display = 'none';
        document.getElementById('actionButtons').style.display = 'none';
      }
    }

    function startTimer() {
      if (!startTime) {
        startTime = new Date();
        document.getElementById('startTimeDisplay').textContent = startTime.toLocaleTimeString();
      }
    }

    function generateEquipmentTable(equipmentList) {
      const tbody = document.getElementById('equipmentTableBody');
      tbody.innerHTML = '';

      equipmentList.forEach((equipment, index) => {
        const row = document.createElement('tr');
        const equipmentKey = `${equipment.name}_${equipment.number}`;
        
        row.innerHTML = `
          <td class="equipment-name">${equipment.name}</td>
          <td class="equipment-number">${equipment.number}</td>
          <td>
            ${equipment.hasFuel ? `
              <select class="fuel-select" onchange="updateFuelColor(this)">
                <option value="">-</option>
                <option value="0">0 (Empty)</option>
                <option value="1">1 (<25%)</option>
                <option value="2">2 (25-50%)</option>
                <option value="3">3 (51-80%)</option>
                <option value="4">4 (80-100%)</option>
              </select>
            ` : '<span class="na-cell">N/A</span>'}
          </td>
          <td>
            ${equipment.hasBattery ? '<input type="number" class="battery-input" placeholder="V" step="0.1">' : '<span class="na-cell">N/A</span>'}
          </td>
          <td>${equipment.hasOil ? '<input type="checkbox">' : '<span class="na-cell">N/A</span>'}</td>
          <td>${equipment.hasATF ? '<input type="checkbox">' : '<span class="na-cell">N/A</span>'}</td>
          <td>${equipment.hasCoolant ? '<input type="checkbox">' : '<span class="na-cell">N/A</span>'}</td>
          <td>${equipment.hasBrake ? '<input type="checkbox">' : '<span class="na-cell">N/A</span>'}</td>
          <td><input type="checkbox"></td>
          <td><input type="checkbox"></td>
          <td><input type="checkbox"></td>
          <td><input type="checkbox"></td>
          <td><input type="checkbox"></td>
          <td>
            <button class="comment-btn" onclick="openCommentModal('${equipmentKey}')" id="commentBtn_${equipmentKey}">ðŸ’¬</button>
          </td>
          <td><input type="text" class="initials-input" maxlength="3" placeholder=""></td>
        `;
        tbody.appendChild(row);
      });
    }

    function generateGPUDSITable(gpuEquipment) {
      const tbody = document.getElementById('gpuDSITableBody');
      tbody.innerHTML = '';
      gpuEquipment.forEach((gpu, index) => {
        const gpuKey = `${gpu.name}_${gpu.number}`;
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="equipment-name">${gpu.name}</td>
          <td class="equipment-number">${gpu.number}</td>
          <td>
            <select class="fuel-select" onchange="updateFuelColor(this)">
              <option value="">-</option>
              <option value="0">0 (Empty)</option>
              <option value="1">1 (<25%)</option>
              <option value="2">2 (25-50%)</option>
              <option value="3">3 (51-80%)</option>
              <option value="4">4 (80-100%)</option>
            </select>
          </td>
          <td><input type="number" class="battery-input" placeholder="V" step="0.1"></td>
          <td><input type="checkbox"></td>
          <td><input type="checkbox"></td>
          <td><input type="checkbox"></td>
          <td><input type="checkbox"></td>
          <td><input type="checkbox"></td>
          <td><input type="checkbox"></td>
          <td><input type="checkbox"></td>
          <td><input type="checkbox"></td>
          <td><input type="checkbox" class="edr-checkbox" title="EDR/Tag Out"></td>
          <td>
            <button class="comment-btn" onclick="openCommentModal('GPU_${gpuKey}')" id="commentBtn_GPU_${gpuKey}">ðŸ’¬</button>
          </td>
          <td><input type="text" class="initials-input" maxlength="3" placeholder=""></td>
        `;
        tbody.appendChild(row);
      });
    }

    function generateGPUSection(gpuEquipment) {
      const tbody = document.getElementById('gpuTableBody');
      tbody.innerHTML = '';
      
      const maxCols = 4;
      for (let i = 0; i < maxCols; i++) {
        const col = document.getElementById(`gpuCol${i + 1}`);
        if (i < gpuEquipment.length) {
          col.textContent = `${gpuEquipment[i].name} ${gpuEquipment[i].number}`;
          col.style.display = 'table-cell';
        } else {
          col.style.display = 'none';
        }
      }

      const inspectionItems = [
        'Inspect cables for damage, cracks, etc.',
        'Inspect cables for exposed wires',
        'Inspect cable ends for damaged/missing insulation',
        'Ensure cable ends are clear of debris, dirt, snow',
        'Record voltage output as shown on meter',
        'Ensure voltage output is constant',
        'Ensure cable trays are clear of debris, dirt, snow'
      ];

      inspectionItems.forEach((item, index) => {
        const row = document.createElement('tr');
        let cells = `<td>${item}</td>`;
        
        for (let i = 0; i < maxCols; i++) {
          if (i < gpuEquipment.length) {
            if (item.includes('Record voltage')) {
              cells += '<td><input type="text" class="voltage-input" placeholder="V"></td>';
            } else {
              cells += '<td><input type="checkbox" class="gpu-check"></td>';
            }
          } else {
            cells += '<td style="display:none;"></td>';
          }
        }
        
        row.innerHTML = cells;
        tbody.appendChild(row);
      });
    }

    function updateFuelColor(select) {
      select.className = 'fuel-select';
      if (select.value) {
        select.classList.add(`fuel-${select.value}`);
      }
    }

    function openCommentModal(equipmentKey) {
      currentCommentEquipment = equipmentKey;
      document.getElementById('modalEquipmentName').textContent = `Equipment: ${equipmentKey.replace('_', ' - ')}`;
      document.getElementById('commentText').value = equipmentComments[equipmentKey] || '';
      document.getElementById('commentModal').style.display = 'block';
    }

    function closeCommentModal() {
      document.getElementById('commentModal').style.display = 'none';
    }

    function saveComment() {
      const comment = document.getElementById('commentText').value.trim();
      equipmentComments[currentCommentEquipment] = comment;
      
      const btn = document.getElementById(`commentBtn_${currentCommentEquipment}`);
      if (comment) {
        btn.classList.add('has-comment');
        btn.textContent = 'ðŸ“';
      } else {
        btn.classList.remove('has-comment');
        btn.textContent = 'ðŸ’¬';
      }
      
      closeCommentModal();
    }

    window.onclick = function(event) {
      const modal = document.getElementById('commentModal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }

    function submitDSI() {
      if (!startTime) {
        alert('Please start the inspection by clicking in the Inspector field first.');
        return;
      }
      const endTime = new Date();
      document.getElementById('endTimeDisplay').textContent = endTime.toLocaleTimeString();
      const inspector = document.getElementById('inspector').value;
      const station = document.getElementById('station').value;
      const date = document.getElementById('inspectionDate').value;
      if (!inspector || !station || !date) {
        alert('Please fill in all required fields (Station, Inspector, Date)');
        return;
      }
      const formData = {
        station: station,
        inspector: inspector,
        date: date,
        startTime: startTime.toISOString(),
        endTime: endTime.toISOString(),
        duration: Math.round((endTime - startTime) / 60000),
        temperature: document.getElementById('temperature').value,
        equipmentData: collectEquipmentData(),
        gpuData: collectGPUData(),
        notes: document.getElementById('additionalNotes').value,
        comments: equipmentComments,
        timestamp: new Date().toISOString()
      };
      console.log('DSI Form Data:', formData);
      sendEmailNotification(formData);
      alert('âœ… Complete! DSI Report sent to management.');
    }

    function sendEmailNotification(formData) {
      const emailSubject = `DSI Report - ${stationConfigs[formData.station].name} - ${formData.date}`;
      let emailBody = `Daily Safety Inspection Report\n\n`;
      emailBody += `Station: ${stationConfigs[formData.station].name}\n`;
      emailBody += `Inspector: ${formData.inspector}\n`;
      emailBody += `Date: ${formData.date}\n`;
      emailBody += `Start Time: ${new Date(formData.startTime).toLocaleTimeString()}\n`;
      emailBody += `End Time: ${new Date(formData.endTime).toLocaleTimeString()}\n`;
      emailBody += `Duration: ${formData.duration} minutes\n`;
      emailBody += `Temperature: ${formData.temperature}Â°C\n\n`;
      emailBody += `EQUIPMENT INSPECTION SUMMARY:\n`;
      emailBody += `=====================================\n`;
      formData.equipmentData.forEach(equipment => {
        emailBody += `${equipment.equipment} ${equipment.number}:\n`;
        if (equipment.fuelLevel) emailBody += `  - Fuel Level: ${equipment.fuelLevel}\n`;
        if (equipment.battery) emailBody += `  - Battery: ${equipment.battery}V\n`;
        emailBody += `  - Oil: ${equipment.oil ? 'OK' : 'N/A'}\n`;
        emailBody += `  - ATF/HYD: ${equipment.atf ? 'OK' : 'N/A'}\n`;
        emailBody += `  - Coolant: ${equipment.coolant ? 'OK' : 'N/A'}\n`;
        emailBody += `  - Brake: ${equipment.brake ? 'OK' : 'N/A'}\n`;
        emailBody += `  - Fire Extinguisher: ${equipment.fireExt ? 'OK' : 'NOT OK'}\n`;
        emailBody += `  - Unit Started: ${equipment.unitStarted ? 'YES' : 'NO'}\n`;
        emailBody += `  - FOD Removed: ${equipment.removeFOD ? 'YES' : 'NO'}\n`;
        emailBody += `  - Safe for Service: ${equipment.safeForService ? 'YES' : 'NO'}\n`;
        emailBody += `  - EDR/Tagged: ${equipment.edrTagged ? 'YES' : 'NO'}\n`;
        emailBody += `  - Inspector Initials: ${equipment.initials}\n\n`;
      });
      // GPU DSI horizontal table summary
      if (formData.gpuData && formData.gpuData.gpuDSIData && formData.gpuData.gpuDSIData.length > 0) {
        emailBody += `GPU DSI SUMMARY:\n`;
        emailBody += `================\n`;
        formData.gpuData.gpuDSIData.forEach(gpu => {
          emailBody += `${gpu.gpu} ${gpu.number}:\n`;
          if (gpu.fuelLevel) emailBody += `  - Fuel Level: ${gpu.fuelLevel}\n`;
          if (gpu.battery) emailBody += `  - Battery: ${gpu.battery}V\n`;
          emailBody += `  - Oil: ${gpu.oil ? 'OK' : 'N/A'}\n`;
          emailBody += `  - ATF/HYD: ${gpu.atf ? 'OK' : 'N/A'}\n`;
          emailBody += `  - Coolant: ${gpu.coolant ? 'OK' : 'N/A'}\n`;
          emailBody += `  - Brake: ${gpu.brake ? 'OK' : 'N/A'}\n`;
          emailBody += `  - Fire Extinguisher: ${gpu.fireExt ? 'OK' : 'NOT OK'}\n`;
          emailBody += `  - Unit Started: ${gpu.unitStarted ? 'YES' : 'NO'}\n`;
          emailBody += `  - FOD Removed: ${gpu.removeFOD ? 'YES' : 'NO'}\n`;
          emailBody += `  - Safe for Service: ${gpu.safeForService ? 'YES' : 'NO'}\n`;
          emailBody += `  - EDR/Tagged: ${gpu.edrTagged ? 'YES' : 'NO'}\n`;
          emailBody += `  - Inspector Initials: ${gpu.initials}\n\n`;
        });
      }
      // GPU vertical inspection table summary
      if (formData.gpuData && formData.gpuData.gpuInspectionData && formData.gpuData.gpuInspectionData.length > 0) {
        emailBody += `GPU INSPECTION SUMMARY:\n`;
        emailBody += `=======================\n`;
        formData.gpuData.gpuInspectionData.forEach(item => {
          emailBody += `${item.item}: ${item.values.join(', ')}\n`;
        });
        emailBody += `\n`;
      }
      if (Object.keys(formData.comments).length > 0) {
        emailBody += `EQUIPMENT COMMENTS:\n`;
        emailBody += `===================\n`;
        for (const [equipment, comment] of Object.entries(formData.comments)) {
          if (comment.trim()) {
            emailBody += `${equipment}: ${comment}\n`;
          }
        }
        emailBody += `\n`;
      }
      if (formData.notes.trim()) {
        emailBody += `ADDITIONAL NOTES:\n`;
        emailBody += `=================\n`;
        emailBody += `${formData.notes}\n\n`;
      }
      emailBody += `Report generated: ${new Date(formData.timestamp).toLocaleString()}\n`;
      emailBody += `Report ID: DSI-${Date.now()}`;

      const recipients = 'sergio.martinez@maintair.com,emmanuel.afolabi@maintair.com';
      const mailtoUrl = `mailto:${recipients}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
      
      window.open(mailtoUrl, '_blank');
    }

    function collectEquipmentData() {
      const rows = document.querySelectorAll('#equipmentTableBody tr');
      const data = [];
      const config = stationConfigs[currentStation];
      
      rows.forEach((row, index) => {
        const cells = row.children;
        const equipment = config.equipment[index];
        data.push({
          equipment: equipment.name,
          number: equipment.number,
          fuelLevel: equipment.hasFuel && cells[2].querySelector('select') ? cells[2].querySelector('select').value : null,
          battery: equipment.hasBattery && cells[3].querySelector('input') ? cells[3].querySelector('input').value : null,
          oil: equipment.hasOil && cells[4].querySelector('input') ? cells[4].querySelector('input').checked : null,
          atf: equipment.hasATF && cells[5].querySelector('input') ? cells[5].querySelector('input').checked : null,
          coolant: equipment.hasCoolant && cells[6].querySelector('input') ? cells[6].querySelector('input').checked : null,
          brake: equipment.hasBrake && cells[7].querySelector('input') ? cells[7].querySelector('input').checked : null,
          fireExt: cells[8].querySelector('input').checked,
          unitStarted: cells[9].querySelector('input').checked,
          removeFOD: cells[10].querySelector('input').checked,
          safeForService: cells[11].querySelector('input').checked,
          edrTagged: cells[12].querySelector('input').checked,
          initials: cells[14].querySelector('input').value
        });
      });
      
      return data;
    }

    function collectGPUData() {
      // Collect horizontal GPU DSI table data
      const gpuDSIRows = document.querySelectorAll('#gpuDSITableBody tr');
      const gpuDSIData = [];
      gpuDSIRows.forEach((row) => {
        const cells = row.children;
        gpuDSIData.push({
          gpu: cells[0].textContent,
          number: cells[1].textContent,
          fuelLevel: cells[2].querySelector('select') ? cells[2].querySelector('select').value : null,
          battery: cells[3].querySelector('input') ? cells[3].querySelector('input').value : null,
          oil: cells[4].querySelector('input') ? cells[4].querySelector('input').checked : null,
          atf: cells[5].querySelector('input') ? cells[5].querySelector('input').checked : null,
          coolant: cells[6].querySelector('input') ? cells[6].querySelector('input').checked : null,
          brake: cells[7].querySelector('input') ? cells[7].querySelector('input').checked : null,
          fireExt: cells[8].querySelector('input') ? cells[8].querySelector('input').checked : null,
          unitStarted: cells[9].querySelector('input') ? cells[9].querySelector('input').checked : null,
          removeFOD: cells[10].querySelector('input') ? cells[10].querySelector('input').checked : null,
          safeForService: cells[11].querySelector('input') ? cells[11].querySelector('input').checked : null,
          edrTagged: cells[12].querySelector('input') ? cells[12].querySelector('input').checked : null,
          initials: cells[14].querySelector('input') ? cells[14].querySelector('input').value : null
        });
      });
      // Collect vertical GPU inspection table data
      const gpuRows = document.querySelectorAll('#gpuTableBody tr');
      const gpuInspectionData = [];
      gpuRows.forEach((row) => {
        const cells = row.children;
        const rowData = {
          item: cells[0].textContent,
          values: []
        };
        for (let i = 1; i < cells.length; i++) {
          const input = cells[i].querySelector('input');
          if (input && cells[i].style.display !== 'none') {
            if (input.type === 'checkbox') {
              rowData.values.push(input.checked ? 'OK' : 'NOT OK');
            } else {
              rowData.values.push(input.value || 'N/A');
            }
          }
        }
        gpuInspectionData.push(rowData);
      });
      return { gpuDSIData, gpuInspectionData };
    }

    function createEDR() {
      saveDraft();
      window.location.href = 'edr.html';
    }

    function saveDraft() {
      const formData = {
        station: document.getElementById('station').value,
        inspector: document.getElementById('inspector').value,
        date: document.getElementById('inspectionDate').value,
        startTime: startTime ? startTime.toISOString() : null,
        temperature: document.getElementById('temperature').value,
        equipmentData: currentStation ? collectEquipmentData() : [],
        gpuData: currentStation ? collectGPUData() : [],
        notes: document.getElementById('additionalNotes').value,
        comments: equipmentComments,
        timestamp: new Date().toISOString()
      };

      const drafts = JSON.parse(sessionStorage.getItem('dsiDrafts') || '[]');
      drafts.push(formData);
      sessionStorage.setItem('dsiDrafts', JSON.stringify(drafts));
      
      alert('ðŸ’¾ DSI draft saved successfully!');
    }

    function goBack() {
      // Instead of forcing a reload or redirect to login, just go to main menu
      // Only clear session if user is signing out
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>